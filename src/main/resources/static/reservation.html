<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>예약 가능 시간대</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #fff8f0;
        }
        .btn-orange {
            background-color: #ff7f50;
            color: white;
        }
        .btn-orange:hover {
            background-color: #ff5722;
            color: white;
        }
    </style>
</head>
<body class="p-4">
<div class="container">
    <h2 class="mb-4 text-center">🕒 예약 가능 시간대</h2>

    <input type="hidden" id="_csrf" name="_csrf" value="">

    <div class="row mb-3">
        <div class="col-md-6">
            <label for="datePicker" class="form-label">날짜 선택</label>
            <input type="date" class="form-control" id="datePicker">
        </div>
        <div class="col-md-6">
            <label for="storeId" class="form-label">가게 ID</label>
            <input type="number" class="form-control" id="storeId" value="1">
        </div>
    </div>

    <button id="loadBtn" class="btn btn-orange mb-4">예약 시간대 불러오기</button>

    <div id="timeSlots" class="d-flex flex-wrap"></div>
</div>

<script>
    let userLevel = 'BRONZE';

    window.onload = function () {
        getCsrfToken();
        document.getElementById("loadBtn").addEventListener("click", loadReservationSlots);
    };

    async function getCsrfToken() {
        const response = await fetch('/csrf-token', { credentials: 'include' });
        const data = await response.json();
        document.getElementById('_csrf').value = data.token;
    }


    async function fetchUserLevel() {
        const res = await fetch('/api/users/info', { credentials: 'include' });
        if (res.ok) {
            const data = await res.json();
            console.log(data.level);
            userLevel = data.level;
        }
    }

    // document.getElementById("loadBtn").addEventListener("click", async () => {
    //     const date = document.getElementById("datePicker").value;
    //     const storeId = document.getElementById("storeId").value;
    //
    //     await fetchUserLevel();
    //     const url = `/api/${userLevel.toLowerCase()}/reservations/available-times?storeId=${storeId}&date=${date}`;
    //
    //     const res = await fetch(url, { credentials: 'include' });
    //     const times = await res.json();
    //
    //     const container = document.getElementById("timeSlots");
    //     container.innerHTML = "";
    //
    //     if (times.length === 0) {
    //         container.innerHTML = "<p class='text-muted'>예약 가능한 시간이 없습니다.</p>";
    //         return;
    //     }
    //
    //     times.forEach(time => {
    //         const btn = document.createElement("button");
    //         btn.className = "btn btn-orange time-slot";
    //         btn.textContent = time;
    //         btn.onclick = () => alert(`${time} 예약 선택됨`);
    //         container.appendChild(btn);
    //     });
    // });

    async function loadReservationSlots() {
        const date = document.getElementById("datePicker").value;
        const storeId = document.getElementById("storeId").value;

        await fetchUserLevel();

        const url = `/api/${userLevel.toLowerCase()}/reservations/available-times?storeId=${storeId}&date=${date}`;
        const res = await fetch(url, { credentials: 'include' });
        const times = await res.json();

        const container = document.getElementById("timeSlots");
        container.innerHTML = "";

        if (times.length === 0) {
            container.innerHTML = "<p class='text-muted'>예약 가능한 시간이 없습니다.</p>";
            return;
        }

        times
            .sort((a, b) => a.startTime.localeCompare(b.startTime))  // startTime 기준 오름차순 정렬
            .forEach((slot, index) => {

                console.log(date);
                console.log(slot);

                const btn = document.createElement("button");
                btn.className = "btn btn-orange m-2";
                btn.textContent = slot.startTime;

                btn.onclick = async () => {
                    const visitDateTime = `${date}T${slot.startTime}`;
                    const _csrf = document.getElementById("_csrf").value;

                    const reservationDto = {
                        storeId: parseInt(storeId),
                        slotId: slot.slotId,
                        visitDate: visitDateTime,
                        _csrf: _csrf
                    };

                    const url = `/api/${userLevel.toLowerCase()}/reservation/crud`;

                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-XSRF-TOKEN": _csrf
                        },
                        body: JSON.stringify({ ...reservationDto, _csrf }),
                        credentials: "include"
                    });

                    const result = await response.json();
                    if (result.result === "success") {
                        alert("예약 성공!");
                    } else {
                        alert("예약 실패: " + result.result);
                    }
                };

                container.appendChild(btn);
            });
    }
</script>
</body>
</html>
